name: Harvest Weather Data Ingestion

on:
  schedule:
    # Run every 6 hours at :05 past the hour (UTC time)
    # This runs at: 12:05am, 6:05am, 12:05pm, 6:05pm UTC
    # Which is: 1:05pm, 7:05pm, 1:05am, 7:05am NZ time (during NZDT)
    - cron: '5 */6 * * *'
  
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  ingest-harvest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: Install Python dependencies
        run: |
          pip install boto3==1.34.0 pydantic==2.5.0 pydantic-settings==2.1.0
          cd ingestion
          pip install -r requirements.txt
      
      - name: Setup stations and run Harvest ingestion
        env:
          ENV: production
          RDS_SECRET_NAME: ${{ secrets.RDS_SECRET_NAME }}
          AWS_REGION: ap-southeast-2
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          HARVEST_API_KEY: ${{ secrets.HARVEST_API_KEY }}
        run: |
          cd ingestion
          python << 'EOF'
          import os
          import json
          from sqlalchemy import text
          from config.harvest_stations import HARVEST_STATIONS
          from sources.harvest import HarvestIngestion
          from db_connection import get_ingestion_engine
          
          print("=" * 60)
          print("Setting up Harvest stations on AWS...")
          print("=" * 60)
          
          engine = get_ingestion_engine()
          
          # Setup stations (idempotent - safe to run multiple times)
          with engine.connect() as conn:
              for station in HARVEST_STATIONS:
                  try:
                      result = conn.execute(
                          text('''
                              INSERT INTO weather_stations
                                  (station_code, station_name, data_source, source_id,
                                   latitude, longitude, elevation, location, region, notes, is_active)
                              VALUES (:code, :name, :source, :source_id, :lat, :lon, :elev,
                                      ST_SetSRID(ST_MakePoint(:lon, :lat), 4326)::geography,
                                      :region, CAST(:notes AS jsonb), true)
                              ON CONFLICT (station_code) 
                              DO UPDATE SET
                                  station_name = EXCLUDED.station_name,
                                  source_id = EXCLUDED.source_id,
                                  latitude = EXCLUDED.latitude,
                                  longitude = EXCLUDED.longitude,
                                  elevation = EXCLUDED.elevation,
                                  location = EXCLUDED.location,
                                  region = EXCLUDED.region,
                                  notes = EXCLUDED.notes,
                                  updated_at = NOW()
                              RETURNING station_id
                          '''),
                          {
                              'code': station['station_code'],
                              'name': station['station_name'],
                              'source': station['data_source'],
                              'source_id': station['source_id'],
                              'lat': station['latitude'],
                              'lon': station['longitude'],
                              'elev': station.get('elevation'),
                              'region': station['region'],
                              'notes': json.dumps(station.get('notes', {}))
                          }
                      )
                      station_id = result.fetchone()[0]
                      print(f"  ✓ {station['station_code']} (ID: {station_id})")
                  except Exception as e:
                      print(f"  ✗ Failed to setup {station['station_code']}: {e}")
              
              conn.commit()
          
          print(f"\n✓ Station setup complete: {len(HARVEST_STATIONS)} stations\n")
          
          # Run ingestion
          print("=" * 60)
          print("Starting Harvest data ingestion...")
          print("=" * 60)
          
          ingester = HarvestIngestion()
          ingester.run()
          
          print("\n✓ Ingestion workflow complete")
          EOF
      
      - name: Check ingestion results
        if: always()
        env:
          ENV: production
          RDS_SECRET_NAME: ${{ secrets.RDS_SECRET_NAME }}
          AWS_REGION: ap-southeast-2
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          cd ingestion
          python << 'EOF'
          from sqlalchemy import text
          from db_connection import get_ingestion_engine
          
          engine = get_ingestion_engine()
          
          with engine.connect() as conn:
              # Get latest ingestion log
              result = conn.execute(text("""
                  SELECT data_source, status, COUNT(*) as count,
                         SUM(records_inserted) as total_records
                  FROM ingestion_log
                  WHERE data_source = 'HARVEST'
                    AND start_time > NOW() - INTERVAL '1 hour'
                  GROUP BY data_source, status
              """))
              
              print("\nIngestion Summary (last hour):")
              for row in result:
                  print(f"  {row[0]} - {row[1]}: {row[2]} runs, {row[3]} records")
          EOF